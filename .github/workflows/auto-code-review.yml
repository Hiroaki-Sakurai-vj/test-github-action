name: Auto Code Review
on:
  pull_request:
    types: [opened, synchronize]

# æ¨©é™è¨­å®šã‚’è¿½åŠ 
permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  code-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      # ESLint ã§ã®ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
      - name: Run ESLint
        run: |
          npx eslint "**/*.{js,ts}" --format json --output-file eslint-results.json || true

      # Security ãƒã‚§ãƒƒã‚¯
      - name: Run Security Audit
        run: |
          npm audit --json > audit-results.json || true

      # è¤‡é›‘åº¦ãƒã‚§ãƒƒã‚¯ï¼ˆsrcé…ä¸‹ã®ã¿å¯¾è±¡ï¼‰
      - name: Check Code Complexity
        run: |
          mkdir -p src
          if [ -d "src" ] && [ "$(find src -name '*.js' -type f | wc -l)" -gt 0 ]; then
            npx plato -r -d complexity-report "src/**/*.js" || true
          else
            echo "No JS files found in src directory, skipping complexity check"
          fi

      # ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’è‡ªå‹•æŠ•ç¨¿
      - name: Post Review Comments
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            try {
              // ESLintçµæœã‚’èª­ã¿è¾¼ã¿
              let eslintResults = [];
              try {
                const eslintData = fs.readFileSync('eslint-results.json', 'utf8');
                eslintResults = JSON.parse(eslintData);
              } catch (e) {
                console.log('No ESLint results found or parsing failed');
              }

              // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ
              const comments = [];
              
              for (const result of eslintResults) {
                for (const message of result.messages) {
                  const comment = {
                    path: result.filePath.replace(process.cwd() + '/', ''),
                    line: message.line,
                    body: `ğŸ¤– **è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼**: ${message.message}\n\n` +
                          `**ãƒ«ãƒ¼ãƒ«**: \`${message.ruleId}\`\n` +
                          `**é‡è¦åº¦**: ${message.severity === 2 ? 'ğŸ”´ ã‚¨ãƒ©ãƒ¼' : 'ğŸŸ¡ è­¦å‘Š'}\n\n` +
                          `**ææ¡ˆ**: ${getFixSuggestion(message.ruleId)}`
                  };
                  comments.push(comment);
                }
              }

              // ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿
              if (comments.length > 0) {
                try {
                  // å€‹åˆ¥ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯æŠ•ç¨¿ã›ãšã€ã¾ã¨ã‚ã¦ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹
                  let reviewBody = `## ğŸ¤– è‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ\n\n` +
                                 `**æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ**: ${comments.length}ä»¶\n` +
                                 `**ãƒ¬ãƒ“ãƒ¥ãƒ¼æ—¥æ™‚**: ${new Date().toLocaleString('ja-JP')}\n\n`;
                  
                  // å„å•é¡Œã‚’è©³ç´°è¡¨ç¤º
                  for (const comment of comments) {
                    reviewBody += `### ğŸ“ ${comment.path} (${comment.line}è¡Œç›®)\n`;
                    reviewBody += `${comment.body}\n\n---\n\n`;
                  }
                  
                  reviewBody += `ä¿®æ­£å¾Œã€å†åº¦ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„ï¼ ğŸš€`;
                  
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    body: reviewBody
                  });
                  console.log('Review comments posted successfully');
                } catch (reviewError) {
                  console.log('Failed to post review comments:', reviewError);
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    body: `## âš ï¸ è‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼\n\nã‚³ãƒ¼ãƒ‰ã«${comments.length}ä»¶ã®å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸãŒã€è©³ç´°ã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`
                  });
                }
              } else {
                // å•é¡ŒãŒãªã„å ´åˆã¯é€šå¸¸ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ï¼ˆæ‰¿èªã¯é¿ã‘ã‚‹ï¼‰
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: `## âœ… è‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†\n\n` +
                        `ğŸ‰ **ç´ æ™´ã‚‰ã—ã„ã‚³ãƒ¼ãƒ‰ã§ã™ï¼**\n` +
                        `- ã‚³ãƒ¼ãƒ‰å“è³ª: è‰¯å¥½\n` +
                        `- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: å•é¡Œãªã—\n` +
                        `- è¤‡é›‘åº¦: é©åˆ‡\n\n` +
                        `**LGTM!** ãƒãƒ¼ã‚¸ã—ã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™ ğŸ‘\n\n` +
                        `*è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼Bot by GitHub Actions*`
                });
              }

            } catch (error) {
              console.error('Error in code review process:', error);
              // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã§ã‚‚ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## âš ï¸ è‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n\næ‰‹å‹•ã§ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`
              });
            }

            function getFixSuggestion(ruleId) {
              const suggestions = {
                'no-unused-vars': 'ä½¿ç”¨ã—ã¦ã„ãªã„å¤‰æ•°ã‚’å‰Šé™¤ã™ã‚‹ã‹ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ä»˜ãã®å¤‰æ•°åã«ã—ã¦ãã ã•ã„',
                'no-console': 'console.logã®ä»£ã‚ã‚Šã«loggerãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„',
                'eqeqeq': '== ã®ä»£ã‚ã‚Šã« === ã‚’ä½¿ç”¨ã—ã¦å³å¯†ç­‰ä¾¡æ¯”è¼ƒã‚’ã—ã¦ãã ã•ã„',
                'no-var': 'var ã®ä»£ã‚ã‚Šã« const ã¾ãŸã¯ let ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„',
                'prefer-const': 'å†ä»£å…¥ã•ã‚Œãªã„å¤‰æ•°ã¯ const ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„',
                'arrow-spacing': 'ã‚¢ãƒ­ãƒ¼é–¢æ•°ã®å‰å¾Œã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„',
                'indent': 'ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’çµ±ä¸€ã—ã¦ãã ã•ã„ï¼ˆ2ã‚¹ãƒšãƒ¼ã‚¹ã¾ãŸã¯4ã‚¹ãƒšãƒ¼ã‚¹ï¼‰'
              };
              return suggestions[ruleId] || 'å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ä¿®æ­£ã—ã¦ãã ã•ã„';
            }